<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{/layout :: setContent(~{this :: title}, ~{this :: link}, ~{this :: content})}">
<header>
    <title  th:text="#{title.userInfo}">Notice Board UserInfo</title>
    <th:block th:fragment="link"></th:block>
</header>
<body>
<th:block th:fragment="content">
    <div class="container px-lg-5">
        <div class="m-auto singup" style="max-width: 500px">
            <form id="userModifyForm" th:method="post" th:action="@{/modify/user}" th:object="${memberDTO}">
                <input type="hidden" id="code" name="code">
                <div class="row border-bottom border-secondary mb-5 mx-1 border-4">
                    <div class="px-0 py-2 py-md-3 d-flex justify-content-center justify-content-md-start"><h1 th:text="#{title.userInfo}">회원 정보</h1>
                    </div>
                </div>
                <div class="form-floating mb-5">
                    <input class="form-control"  type="text" id="username" th:field="*{username}" placeholder="아이디" disabled/>
                    <label for="username">아이디</label>
                </div>
                <div class="form-floating mb-5">
                    <input class="form-control" id="name" th:field="*{name}" type="text"  placeholder="이름" disabled/>
                    <label for="name">이름</label>
                </div>
                <div class="input-group mb-5">
                    <div class="form-floating w-75">
                        <input class="form-control" type="email" id="email" th:field="*{email}" placeholder="이메일" disabled/>
                        <label for="email">이메일</label>
                    </div>
                    <button class="btn btn-outline-primary small w-25 px-2 py-1" id="emailModBtn" type="button" data-bs-toggle="modal" data-bs-target="#modify">수정 하기
                    </button>
                </div>
                <div class="input-group">
                    <div class="form-floating w-75">
                        <input class="form-control" id="password" th:field="*{password}" type="pasword" placeholder="비밀번호" disabled/>
                        <label for="password">비밀번호</label>
                    </div>
                    <button class="btn btn-outline-primary small w-25 px-2 py-1" id="passwordModBtn" type="button"
                            data-bs-toggle="modal" data-bs-target="#modify">수정 하기
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal fade" id="modify" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
         aria-labelledby="modifyLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="modifyLabel"></h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                </div>
                <div class="modal-footer">
                    <button type="button" id="modifyBtn" class="btn btn-primary">수정하기</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        $(document).ready(function () {
            $("#emailModBtn").click(function () {
                $(".modal-title").text("이메일 수정");
                let str = "";
                str += "<div class='input-group'>"
                str += "<div class='form-floating w-75'>"
                str += "        <input class='form-control' id='newEmail' type='email' placeholder='이메일'/>"
                str += "        <label for='editEmail'>새로운 이메일</label>"
                str += "        <div class='valid-feedback' style='font-size: 0.7em'></div>"
                str += "        <div class='invalid-feedback' style='font-size: 0.7em'></div>"
                str += "    </div>"
                str += "    <button class='btn btn-primary small w-25 px-2 py-1 mt-3' style='height: 56px' id='sendCodeBtn' type='button'>인증번호 받기 </button>"
                str += "</div>"
                str += "<div class='form-floating mb-5'>"
                str += "    <input class='form-control' id='code' maxLength='6' name='code' type='number' placeholder='인증번호'/>"
                str += "    <label for='code'>인증번호</label>"
                str += "    <div class='valid-feedback' style='font-size: 0.7em'>인증이 성공하였습니다.</div>"
                str += "    <div class='invalid-feedback' style='font-size: 0.7em'></div>"
                str += "</div>"
                $(".modal-body").html(str);

                <!--이메일 유효성 검사-->
                let newEmailElement = $('#email');
                newEmailElement.focusout(function () {
                    let email = newEmailElement.val();
                    let invalidFeedback = newEmailElement.siblings(".invalid-feedback");
                    let regExp = RegExp(/^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*.[a-zA-Z]{2,3}$/i);
                    if (email == "") {
                        invalidFeedback.text("이메일을 입력해 주세요.");
                        newEmailElement.removeClass("is-valid");
                        newEmailElement.addClass("is-invalid");
                    } else {
                        if (!regExp.test(email)) {
                            invalidFeedback.text("이메일을 다시 확인해 주세요");
                            newEmailElement.removeClass("is-valid");
                            newEmailElement.addClass("is-invalid");
                        } else {
                            newEmailElement.removeClass("is-invalid");
                            newEmailElement.addClass("is-valid");
                        }
                    }
                });

                <!-- 이메일 인증번호 발송 -->
                let usernameElement = $("#username");
                $('#sendCodeBtn').click(function () {
                    if (emailElement.hasClass("is-valid")) {
                        let email = newEmailElement.val();
                        let username = usernameElement.val()
                        let invalidFeedback = newEmailElement.siblings(".invalid-feedback");
                        let validFeedback = newEmailElement.siblings(".valid-feedback");
                        if (newEmailElement.hasClass("is-valid")) {
                            $.ajax({
                                url: '/send/email',
                                method: 'POST',
                                data: {email: email, username: username},
                                success: function (result) {
                                    validFeedback.text(result)
                                }, error: function (jqXHR) {
                                    invalidFeedback.text(jqXHR.responseText);
                                    newEmailElement.removeClass("is-valid");
                                    newEmailElement.addClass("is-invalid");
                                }
                            });
                        }
                    }
                });

                <!-- 인증번호 유효성 검사 -->
                let codeElement = $('#code');
                codeElement.focusout(function () {
                    let code = codeElement.val();
                    let email = newEmailElement.val();
                    let validFeedback = codeElement.siblings(".valid-feedback");
                    let invalidFeedback = codeElement.siblings(".invalid-feedback");
                    if (code == "") {
                        invalidFeedback.text("인증번호를 입력해 주세요.");
                        codeElement.removeClass("is-valid");
                        codeElement.addClass("is-invalid");
                    } else {
                        $.ajax({
                            url: "/check/code",
                            method: 'get',
                            data: {email: email, code: code},
                            success: function (result) {
                                if (result.first) {
                                    validFeedback.text(result.second);
                                    codeElement.removeClass("is-invalid");
                                    codeElement.addClass("is-valid");
                                } else {
                                    validFeedback.text(result.second);
                                    codeElement.removeClass("is-valid");
                                    codeElement.addClass("is-invalid");
                                }
                            }
                        })
                    }
                });

                //form 유효성 검사
                $("#modifyBtn").click(function () {
                    let isNewEmailValid = newEmailElement.hasClass("is-valid");
                    let isCodeValid = codeElement.hasClass("is-valid")
                    if (isNewEmailValid && isCodeValid) {
                        $("#username").removeAttr("disabled");
                        $("#name").removeAttr("disabled");
                        $("#email").removeAttr("disabled");
                        $("#password").removeAttr("disabled");
                        $("#email").val(newEmailElement.val());
                        $("#userModifyForm").submit();
                    }
                });
            });

            $("#passwordModBtn").click(function () {
                $(".modal-title").text("비밀번호 수정");
                let str = "";
                str += "<div class='form-floating mb-3'>"
                str += "    <input class='form-control' id='oldPassword' type='password' placeholder='비밀번호'/>"
                str += "    <label for='oldPassword'>현재 비밀번호</label>"
                str += "    <div class='invalid-feedback' style='font-size: 0.7em'></div>"
                str += "</div>"
                str += "<div class='form-floating mb-3'>"
                str += "    <input class='form-control' id='newPassword' name='password' type='password' placeholder='비밀번호'/>"
                str += "    <label for='password'>새 비밀번호</label>"
                str += "    <div class='invalid-feedback' style='font-size: 0.7em'></div>"
                str += "</div>"
                str += "<div class='form-floating mb-3'>"
                str += "    <input class='form-control' id='passwordConfirm' name='passwordConfirm' type='password' placeholder='비밀번호 제확인'/>"
                str += "    <label for='passwordConfirm'>새 비밀번호 재확인</label>"
                str += "    <div class='invalid-feedback' style='font-size: 0.7em'></div>"
                str += "</div>"
                $(".modal-body").html(str);

                <!-- 현 비밀번호 유효성 검사-->
                let oldPasswordElement = $('#oldPassword');
                let usernameElement = $("#username");
                oldPasswordElement.focusout(function () {
                    let oldPassword = oldPasswordElement.val();
                    let username = usernameElement.val();
                    let invalidFeedback = oldPasswordElement.siblings(".invalid-feedback");
                    let regExp = RegExp(/^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,16}$/);
                    if (oldPassword == "") {
                        invalidFeedback.text("비밀번호를 입력해 주세요.");
                        oldPasswordElement.removeClass("is-valid");
                        oldPasswordElement.addClass("is-invalid");
                    } else {
                        if (regExp.test(oldPassword)) {
                            $.ajax({
                                url: "/check/password",
                                method: 'get',
                                data: {username: username, password: oldPassword},
                                success: function (result) {
                                    if (result) {
                                        oldPasswordElement.removeClass("is-invalid");
                                        oldPasswordElement.addClass("is-valid");
                                    } else {
                                        invalidFeedback.text("비밀번호가 일치하지 않습니다.");
                                        oldPasswordElement.removeClass("is-valid");
                                        oldPasswordElement.addClass("is-invalid");
                                    }
                                }
                            });
                        } else {
                            invalidFeedback.text("8~16자 영문 대 소문자, 숫자, 특수문자를 사용하세요.");
                            oldPasswordElement.removeClass("is-valid");
                            oldPasswordElement.addClass("is-invalid");
                        }
                    }
                });

                <!--새 비밀번호 유효성 검사-->
                let newPasswordElement = $('#newPassword');
                newPasswordElement.focusout(function () {
                    let newPassword = newPasswordElement.val();
                    let invalidFeedback = newPasswordElement.siblings(".invalid-feedback");
                    let regExp = RegExp(/^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,16}$/);
                    if (newPassword == "") {
                        invalidFeedback.text("비밀번호를 입력해 주세요.");
                        newPasswordElement.removeClass("is-valid");
                        newPasswordElement.addClass("is-invalid");
                    } else {
                        if (regExp.test(newPassword)) {
                            newPasswordElement.removeClass("is-invalid");
                            newPasswordElement.addClass("is-valid");
                        } else {
                            invalidFeedback.text("8~16자 영문 대 소문자, 숫자, 특수문자를 사용하세요.");
                            newPasswordElement.removeClass("is-valid");
                            newPasswordElement.addClass("is-invalid");
                        }
                    }
                });

                <!--새 비밀번호 재확인 유효성 검사-->
                let newPasswordConfirmElement = $('#passwordConfirm');
                newPasswordConfirmElement.focusout(function () {
                    let newPassword = newPasswordElement.val();
                    let newPasswordConfirm = newPasswordConfirmElement.val();
                    let invalidFeedback = newPasswordConfirmElement.siblings(".invalid-feedback");
                    if (newPasswordConfirm == "") {
                        invalidFeedback.text("비밀번호를 입력해 주세요.");
                        newPasswordConfirmElement.removeClass("is-valid");
                        newPasswordConfirmElement.addClass("is-invalid");
                    } else {
                        if (newPassword == newPasswordConfirm) {
                            newPasswordConfirmElement.removeClass("is-invalid");
                            newPasswordConfirmElement.addClass("is-valid");
                        } else {
                            invalidFeedback.text("비밀번호가 일치하지 않습니다.");
                            newPasswordConfirmElement.removeClass("is-valid");
                            newPasswordConfirmElement.addClass("is-invalid");
                        }
                    }
                });

                //form 유효성 검사
                $("#modifyBtn").click(function () {
                    let isOldPasswordValid = oldPasswordElement.hasClass("is-valid")
                    let isNewPasswordValid = newPasswordElement.hasClass("is-valid");
                    let isNewPasswordConfirmValid = newPasswordConfirmElement.hasClass("is-valid")
                    if (isOldPasswordValid && isNewPasswordValid && isNewPasswordConfirmValid) {
                        $("#username").removeAttr("disabled");
                        $("#name").removeAttr("disabled");
                        $("#email").removeAttr("disabled");
                        $("#password").removeAttr("disabled");
                        $("#password").val(newPasswordElement.val());
                        $("#userModifyForm").submit();
                    }
                });
            });

        });
    </script>
</th:block>
</body>
</html>