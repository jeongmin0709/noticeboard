<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{/layout :: setContent(~{this :: title}, ~{this :: link}, ~{this :: content})}">
<header>
    <title th:text="#{title.signup}">Notice Board SignUp</title>
    <th:block th:fragment="link"></th:block>
</header>
<body>
<th:block th:fragment="content">
    <div class="container px-lg-5">
        <div class="m-auto singup" style="max-width: 500px">
            <div class="row border-bottom border-secondary mb-4 mx-1 border-4">
                <div class="px-0 py-2 py-md-3 d-flex justify-content-center justify-content-md-start"><h1  th:text="#{title.signup}">회원 가입</h1>
                </div>
            </div>
            <form id="signupForm" th:action="@{/signup}" th:method="post" th:object="${memberDTO}">
                <input type="hidden" name="uuid">
                <div class="form-floating mb-3">
                    <input class="form-control" id="username" th:field="*{username}" th:errorclass="is-invalid" type="text" placeholder="아이디"/>
                    <label for="username">아이디</label>
                    <div class="invalid-feedback" style="font-size: 0.7em"><span th:errors="*{username}"></span></div>
                    <div class="valid-feedback" style="font-size: 0.7em">멋진 아이디네요.</div>
                </div>
                <div class="form-floating mb-3">
                    <input class="form-control" id="password" th:field="*{password}" th:errorclass="is-invalid" type="password" placeholder="비밀번호"/>
                    <label for="password">비밀번호</label>
                    <div class="invalid-feedback" style="font-size: 0.7em"><span th:errors="*{password}"></span></div>
                </div>
                <div class="form-floating mb-3">
                    <input class="form-control" id="passwordConfirm" th:field="*{passwordConfirm}" th:errorclass="is-invalid" type="password" placeholder="비밀번호 제확인"/>
                    <label for="passwordConfirm">비밀번호 재확인</label>
                    <div class="invalid-feedback" style="font-size: 0.7em"><span th:errors="*{passwordConfirm}"></span></div>
                </div>
                <div class="form-floating mb-3">
                    <input class="form-control" id="name" th:field="*{name}" th:errorclass="is-invalid" type="text" placeholder="이름"/>
                    <label for="name">이름</label>
                    <div class="invalid-feedback" style="font-size: 0.7em"><span th:errors="*{name}"></span></div>
                </div>
                <div class="input-group">
                    <div class="form-floating w-75">
                        <input class="form-control" id="email" th:field="*{email}" th:errorclass="is-invalid" type="email" placeholder="이메일"/>
                        <label for="email">이메일</label>
                        <div class="valid-feedback" style="font-size: 0.7em"></div>
                        <div class="invalid-feedback" style="font-size: 0.7em"><span th:errors="*{email}"></span></div>
                    </div>
                    <button class="btn btn-primary small w-25 px-2 py-1 mt-3" style="height: 56px" id="sendCodeBtn"
                            type="button" disabled>인증번호 받기
                    </button>
                </div>
                <div class="form-floating mb-5">
                    <input class="form-control" id="code" maxlength="6" th:field="*{code}" th:errorclass="is-invalid" type="number" placeholder="인증번호"/>
                    <label for="code">인증번호</label>
                    <div class="valid-feedback" style="font-size: 0.7em">인증이 성공하였습니다.</div>
                    <div class="invalid-feedback" style="font-size: 0.7em"><span th:errors="*{code}">인증번호가 일치하지 않습니다.</span></div>
                </div>
                <div class="d-grid mb-3">
                    <button class="btn btn-primary fs-5" type="submit">회원 가입</button>
                </div>
            </form>
        </div>
    </div>
    <script th:inline="javascript">
        $(document).ready(function () {

            <!--아이디 유효성 검사-->
            let usernameEelement = $("#username");
            usernameEelement.focusout(function () {
                let username = usernameEelement.val();
                let invalidFeedback = usernameEelement.siblings(".invalid-feedback");
                let regExp = RegExp(/^[A-Za-z0-9_\-]{5,20}$/);
                if (username == "") {
                    invalidFeedback.text("아이디를 입력해 주세요.");
                    usernameEelement.removeClass("is-valid");
                    usernameEelement.addClass("is-invalid");
                } else {
                    if (regExp.test(username)) {
                        $.ajax({
                            url: '/check/username',
                            method: 'get',
                            data: {username: username},
                            success: function (result) {
                                if (result) {
                                    invalidFeedback.text("이미 사용중인 아이디입니다.");
                                    usernameEelement.removeClass("is-valid");
                                    usernameEelement.addClass("is-invalid");
                                } else {
                                    usernameEelement.removeClass("is-invalid");
                                    usernameEelement.addClass("is-valid");
                                }
                            }
                        });
                    } else {
                        invalidFeedback.text("5~20자의 영문 소문자, 숫자와 특수기호(_),(-)만 사용 가능합니다.");
                        usernameEelement.removeClass("is-valid");
                        usernameEelement.addClass("is-invalid");
                    }
                }
            });

            <!--비밀번호 유효성 검사-->
            let passwordEelement = $('#password');
            passwordEelement.focusout(function () {
                let password = passwordEelement.val();
                let invalidFeedback = passwordEelement.siblings(".invalid-feedback");
                let regExp = RegExp(/^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{8,16}$/);
                if (password == "") {
                    invalidFeedback.text("비밀번호를 입력해 주세요.");
                    passwordEelement.removeClass("is-valid");
                    passwordEelement.addClass("is-invalid");
                } else {
                    if (regExp.test(password)) {
                        passwordEelement.removeClass("is-invalid");
                        passwordEelement.addClass("is-valid");
                    } else {
                        invalidFeedback.text("8~16자 영문 대 소문자, 숫자, 특수문자를 사용하세요.");
                        passwordEelement.removeClass("is-valid");
                        passwordEelement.addClass("is-invalid");
                    }
                }
            });

            <!--비밀번호 재확인 유효성 검사-->
            let passwordConfirmEelement = $('#passwordConfirm');
            passwordConfirmEelement.focusout(function () {
                let password = passwordEelement.val();
                let passwordConfirm = passwordConfirmEelement.val();
                let invalidFeedback = passwordConfirmEelement.siblings(".invalid-feedback");
                if (passwordConfirm == "") {
                    invalidFeedback.text("비밀번호를 입력해 주세요.");
                    passwordConfirmEelement.removeClass("is-valid");
                    passwordConfirmEelement.addClass("is-invalid");
                } else {
                    if (password == passwordConfirm) {
                        passwordConfirmEelement.removeClass("is-invalid");
                        passwordConfirmEelement.addClass("is-valid");
                    } else {
                        invalidFeedback.text("비밀번호가 일치하지 않습니다.");
                        passwordConfirmEelement.removeClass("is-valid");
                        passwordConfirmEelement.addClass("is-invalid");
                    }
                }
            });

            <!--이름 유효성 검사-->
            let nameEelement = $('#name');
            nameEelement.focusout(function () {
                let name = nameEelement.val();
                let invalidFeedback = nameEelement.siblings(".invalid-feedback");
                let regExp = RegExp(/^[가-힣]{2,6}$/);
                if (name == "") {
                    invalidFeedback.text("이름을 입력해 주세요.");
                    nameEelement.removeClass("is-valid");
                    nameEelement.addClass("is-invalid");
                } else {
                    if (regExp.test(name)) {
                        nameEelement.removeClass("is-invalid");
                        nameEelement.addClass("is-valid");
                    } else {
                        invalidFeedback.text("이름을 다시 확인해 주세요");
                        nameEelement.removeClass("is-valid");
                        nameEelement.addClass("is-invalid");
                    }
                }
            });

            <!--이메일 유효성 검사-->
            let emailEelement = $('#email');
            emailEelement.focusout(function () {
                let email = emailEelement.val();
                let invalidFeedback = emailEelement.siblings(".invalid-feedback");
                let regExp = RegExp(/^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*.[a-zA-Z]{2,3}$/i);
                if (email == "") {
                    invalidFeedback.text("이메일을 입력해 주세요.");
                    emailEelement.removeClass("is-valid");
                    emailEelement.addClass("is-invalid");
                } else {
                    if (!regExp.test(email)) {
                        invalidFeedback.text("이메일을 다시 확인해 주세요");
                        emailEelement.removeClass("is-valid");
                        emailEelement.addClass("is-invalid");
                    } else {
                        $('#sendCodeBtn').removeAttr("disabled")
                        emailEelement.removeClass("is-invalid");
                        emailEelement.addClass("is-valid");
                    }
                }
            });

            <!-- 이메일 인증번호 발송 -->
            $('#sendCodeBtn').click(function () {
                if (emailEelement.hasClass("is-valid")) {
                    let email = emailEelement.val();
                    let invalidFeedback = emailEelement.siblings(".invalid-feedback");
                    let validFeedback = emailEelement.siblings(".valid-feedback");
                    if (emailEelement.hasClass("is-valid")) {
                        $.ajax({
                            url: '/email',
                            method: 'POST',
                            data: {email: email},
                            success: function (result) {
                                validFeedback.text(result)
                            }, error: function (jqXHR) {
                                invalidFeedback.text(jqXHR.responseText);
                                emailEelement.removeClass("is-valid");
                                emailEelement.addClass("is-invalid");
                            }
                        });
                    }
                }
            });

            <!-- 인증번호 유효성 검사 -->
            let codeEelement = $('#code');
            codeEelement.focusout(function () {
                let code = codeEelement.val();
                let email = emailEelement.val();
                let validFeedback = codeEelement.siblings(".valid-feedback");
                let invalidFeedback = codeEelement.siblings(".invalid-feedback");
                if (code == "") {
                    invalidFeedback.text("인증번호를 입력해 주세요.");
                    codeEelement.removeClass("is-valid");
                    codeEelement.addClass("is-invalid");
                } else {
                    $.ajax({
                        url: "/check/code",
                        method: 'GET',
                        data: {email: email, code: code},
                        success: function (result) {
                            if (result) {
                                codeEelement.removeClass("is-invalid");
                                codeEelement.addClass("is-valid");
                            } else {
                                codeEelement.removeClass("is-valid");
                                codeEelement.addClass("is-invalid");
                            }
                        }, error: function (jqXHR) {
                            invalidFeedback.text(jqXHR.responseText);
                            emailEelement.removeClass("is-valid");
                            emailEelement.addClass("is-invalid");
                        }
                    })
                }
            });

            <!--form 유효성 검사-->
            $("#signupForm").submit(function () {
                let isUsernameValid = usernameEelement.hasClass("is-valid");
                let isPasswordValid = passwordEelement.hasClass("is-valid");
                let isPasswordConfirmValid = passwordConfirmEelement.hasClass("is-valid");
                let isNameValid = nameEelement.hasClass("is-valid");
                let isEmailValid = emailEelement.hasClass("is-valid");
                let isCodeValid = codeEelement.hasClass("is-valid")
                if (isUsernameValid && isPasswordValid && isPasswordConfirmValid && isNameValid && isEmailValid && isCodeValid) {
                    return true;
                }
                return false;
            });
        })
    </script>
</th:block>
</body>
</html>